{% load site_tags %}
<script id="script-{{ id }}">
	let ad_elements = [
		{% for ad in ads %}
			$("<div style='margin-bottom: 10px' id='{{ ids|index:forloop.counter0 }}' class='__{{ ad.placement }}'</div>"),
		{% endfor %}
	];
	let last = ad_elements.pop();
	let parent_contaner = $('#script-{{ id }}').parent();
	let n = ~~(parent_contaner.height()/1000);
	parent_contaner.append(ad_elements[0]);
	var i;
	for (i = 1; i < n && i < ad_elements.length; i++){
		parent_contaner.append(ad_elements[i]);
	}
	if (i < n) {
		parent_contaner.append(last)
	}
</script>
<script>
	var gptadslots = [];
	var googletag = googletag || {cmd: []};
	googletag.cmd.push(function () {
	{% for mapping in mappings %}
		{% if mapping %}var {{ mapping.name }} = {{ mapping.script }};{% endif %}
	{% endfor %}
	{% for ad in ads %}
		gptadslots.push(googletag.defineSlot('/21671132665/{{ ad.adunit_code }}', {{ ad.adunit_sizes }}, '{{ ids|index:forloop.counter0 }}')
			{% if ad.size_mapping %}.defineSizeMapping({{ ad.size_mapping.name }}){% endif %}
			.addService(googletag.pubads()));
	{% endfor %}
		googletag.pubads().enableLazyLoad({
			fetchMarginPercent: 500,
			renderMarginPercent: 200,
			mobileScaling: 2.0
		});
		googletag.enableServices();
	});

	let adunits = document.querySelectorAll('div[id^="{{ id }}-"]');
	for (let i = 0; i < adunits.length; i++) {
		googletag.cmd.push(function () {
			googletag.display(adunits[i].getAttribute('id'));
		});
	}

</script>
