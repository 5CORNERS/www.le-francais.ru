(function($){window.SequenceMember=function(sequence,prefix){var self={};self.prefix=prefix;self.container=$("#"+self.prefix+"-container");var indexField=$("#"+self.prefix+"-order");self.delete=function(){sequence.deleteMember(self)};self.prependMember=function(template){sequence.insertMemberBefore(self,template)};self.appendMember=function(template){sequence.insertMemberAfter(self,template)};self.moveUp=function(){sequence.moveMemberUp(self)};self.moveDown=function(){sequence.moveMemberDown(self)};self._markDeleted=function(){$("#"+self.prefix+"-deleted").val("1");self.container.slideUp().dequeue().fadeOut()};self._markAdded=function(){self.container.hide();self.container.slideDown();var timeout=setTimeout(function(){$(".input input,.input textarea,.input .richtext",self.container).first().focus()},250)};self.getIndex=function(){return parseInt(indexField.val(),10)};self.setIndex=function(i){indexField.val(i)};return self};window.Sequence=function(opts){var self={};var list=$("#"+opts.prefix+"-list");var countField=$("#"+opts.prefix+"-count");var members=[];self.getCount=function(){return parseInt(countField.val(),10)};function getNewMemberPrefix(){var newIndex=self.getCount();countField.val(newIndex+1);return opts.prefix+"-"+newIndex}function setInitialMoveUpDownState(newMember){}function postInsertMember(newMember){if(opts.onInitializeMember){opts.onInitializeMember(newMember)}var index=newMember.getIndex();if(index===0){if(opts.onDisableMoveUp)opts.onDisableMoveUp(newMember)}else{if(opts.onEnableMoveUp)opts.onEnableMoveUp(newMember)}if(index===members.length-1){if(opts.onDisableMoveDown)opts.onDisableMoveDown(newMember)}else{if(opts.onEnableMoveDown)opts.onEnableMoveDown(newMember)}newMember._markAdded()}function elementFromTemplate(template,newPrefix){return $(template.replace(/__PREFIX__/g,newPrefix).replace(/<-(-*)\/script>/g,"<$1/script>"))}self.insertMemberBefore=function(otherMember,template){newMemberPrefix=getNewMemberPrefix();var elem=elementFromTemplate(template,newMemberPrefix);otherMember.container.before(elem);var newMember=SequenceMember(self,newMemberPrefix);var index=otherMember.getIndex();for(var i=index;i<members.length;i++){members[i].setIndex(i+1)}members.splice(index,0,newMember);newMember.setIndex(index);postInsertMember(newMember);if(index===0&&opts.onEnableMoveUp){opts.onEnableMoveUp(otherMember)}return newMember};self.insertMemberAfter=function(otherMember,template){newMemberPrefix=getNewMemberPrefix();var elem=elementFromTemplate(template,newMemberPrefix);otherMember.container.after(elem);var newMember=SequenceMember(self,newMemberPrefix);var index=otherMember.getIndex()+1;for(var i=index;i<members.length;i++){members[i].setIndex(i+1)}members.splice(index,0,newMember);newMember.setIndex(index);postInsertMember(newMember);if(index===members.length-1&&opts.onEnableMoveDown){opts.onEnableMoveDown(otherMember)}return newMember};self.insertMemberAtStart=function(template){newMemberPrefix=getNewMemberPrefix();var elem=elementFromTemplate(template,newMemberPrefix);list.prepend(elem);var newMember=SequenceMember(self,newMemberPrefix);for(var i=0;i<members.length;i++){members[i].setIndex(i+1)}members.unshift(newMember);newMember.setIndex(0);postInsertMember(newMember);if(members.length>1&&opts.onEnableMoveUp){opts.onEnableMoveUp(members[1])}return newMember};self.insertMemberAtEnd=function(template){newMemberPrefix=getNewMemberPrefix();var elem=elementFromTemplate(template,newMemberPrefix);list.append(elem);var newMember=SequenceMember(self,newMemberPrefix);newMember.setIndex(members.length);members.push(newMember);postInsertMember(newMember);if(members.length>1&&opts.onEnableMoveDown){opts.onEnableMoveDown(members[members.length-2])}return newMember};self.deleteMember=function(member){var index=member.getIndex();for(var i=index+1;i<members.length;i++){members[i].setIndex(i-1)}members.splice(index,1);member._markDeleted();if(index===0&&members.length>0&&opts.onDisableMoveUp){opts.onDisableMoveUp(members[0])}if(index===members.length&&members.length>0&&opts.onDisableMoveDown){opts.onDisableMoveDown(members[members.length-1])}};self.moveMemberUp=function(member){var oldIndex=member.getIndex();if(oldIndex>0){var newIndex=oldIndex-1;var swappedMember=members[newIndex];members[newIndex]=member;member.setIndex(newIndex);members[oldIndex]=swappedMember;swappedMember.setIndex(oldIndex);member.container.insertBefore(swappedMember.container);if(newIndex===0){if(opts.onDisableMoveUp)opts.onDisableMoveUp(member);if(opts.onEnableMoveUp)opts.onEnableMoveUp(swappedMember)}if(oldIndex===members.length-1){if(opts.onEnableMoveDown)opts.onEnableMoveDown(member);if(opts.onDisableMoveDown)opts.onDisableMoveDown(swappedMember)}}};self.moveMemberDown=function(member){var oldIndex=member.getIndex();if(oldIndex<members.length-1){var newIndex=oldIndex+1;var swappedMember=members[newIndex];members[newIndex]=member;member.setIndex(newIndex);members[oldIndex]=swappedMember;swappedMember.setIndex(oldIndex);member.container.insertAfter(swappedMember.container);if(newIndex===members.length-1){if(opts.onDisableMoveDown)opts.onDisableMoveDown(member);if(opts.onEnableMoveDown)opts.onEnableMoveDown(swappedMember)}if(oldIndex===0){if(opts.onEnableMoveUp)opts.onEnableMoveUp(member);if(opts.onDisableMoveUp)opts.onDisableMoveUp(swappedMember)}}};var count=self.getCount();for(var i=0;i<count;i++){var memberPrefix=opts.prefix+"-"+i;var sequenceMember=SequenceMember(self,memberPrefix);members[i]=sequenceMember;if(opts.onInitializeMember){opts.onInitializeMember(sequenceMember)}if(i===0){if(opts.onDisableMoveUp)opts.onDisableMoveUp(sequenceMember)}else{if(opts.onEnableMoveUp)opts.onEnableMoveUp(sequenceMember)}if(i===count-1){if(opts.onDisableMoveDown)opts.onDisableMoveDown(sequenceMember)}else{if(opts.onEnableMoveDown)opts.onEnableMoveDown(sequenceMember)}}return self}})(jQuery);